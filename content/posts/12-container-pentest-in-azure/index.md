---
title: "Container-based penetration testing infrastructure in Azure"
date: 2022-12-16T05:45:49+10:30
slug: container-pentest-in-azure
draft: true 
categories:
- All
- Application Security
tags:
- Cloud
- Docker
- Kali
- Penetration Testing
- Bug Bounty
comments: true
ShowToc: true

# cover:
#   image: "run-python.gif"
#   alt: "Running a python script inside a kali docker container running on Windows."
#   relative: true
---

One of my favourite aspects of penetration testing is that there is plenty of opportunity for [continuous improvement](https://jamesclear.com/continuous-improvement). Engagements are typically short, with a clear project lifecycle that is repeated for each engagement. If we can marginally improve our process each time we perform a penetration test, these marginal improvements compound over time, which is how we can achieve significant growth in the long-term.

One aspect of the penetration testing engagement lifecycle that has captured my interest over recent years is the management of penetration testing infrastructure. If we can minimise the time spent maintaining penetration testing tooling and spin up testing infrastructure faster at the beginning of an engagement, then we can spend more time providing value to our clients by diving deep into interesting bugs.

I have written in the past about how Docker containers solve several issues I have faced in the past when maintaining VM-based infrastructure. For more information, I recommend you check out this blog post, but in summary:

* It is imperative that we harden our penetration testing infrastructure to protect ourselves and our clients. However, maintaining a hardened SOE can be a time-intensive process, if performed manually.  
* Each time our SOE is updated with new security patches or standardised tooling and configuration, each penetration tester needs to re-baseline their personalised VM on the updated SOE by re-installing and re-configuring their preferred tooling. This is an additional time sink, which is multiplied by the number of testers in the team.

This problem got me thinking: could we borrow from the DevOps toolkit to optimise the management and deployment of penetration testing infrastructure?

* Docker images are defined as code, making it simpler to manage a hardened SOE with standardised tooling and configuration.  
* We can utilise DevSecOps tooling like SCA and Infrastructure as Code scanning tools to identify vulnerable tools and configurations.  
* Docker images natively support the ability to base one image off another. Each penetration tester can base their personalised image definition off the hardened SOE, then incorporate upstream changes by simply rebuilding their container.  
* Using CI / CD pipelines and cloud compute, we can automate the process of spinning up and tearing down containers as required per engagement.

## Pentest Infrastructure Nirvana?
It seemed as though, through DevOps tooling, developers had shown us security folk the path to penetration testing Nirvana. Shall we give it a new name? PenTestOps? That seems to be the done thing when applying DevOps practices to a new field. (I kid, please don'tâ€¦)

In practice, I found one key limitation that prevented my team from using this approach in a cost-effective manner. One requirement for penetration testing infrastructure is having a predictable, static IP address that all testing traffic will originate from, throughout the life of an engagement. This is for a couple of reasons:

* The client's security team will likely want to be able to identify which traffic is part of the penetration test, as opposed to traffic that may be coming from another (potentially malicious) source.  
* If the client has a WAF or similar infrastructure, we'll need to give them an IP address so they can add it to the allow-list.

For a multitude of reasons relating to some specific requirements for our organisation when selecting a cloud provider to host our infrastructure, the cost estimates for running the planned infrastructure, plus the static outbound IP requirement, I was unable to find a suitable hosting provider when I first wrote about this in 2020.

{{< tweet user="JakobTheDev" id="1539060676559138816" >}}

That recently changed. Here's how we've started using our new container-based penetration testing infrastructure.

## New baseline infrastructure
