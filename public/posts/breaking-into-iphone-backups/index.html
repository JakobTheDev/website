<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Breaking into Encrypted iPhone Backups | JakobTheDev | Jakob Pennington</title><meta name=keywords content="Cryptography,iPhone,Password Cracking"><meta name=description content="The day that being a hacker made me feel like a hero."><meta name=author content="Jakob Pennington"><link rel=canonical href=https://www.jakobthe.dev/posts/breaking-into-iphone-backups/><meta name=google-site-verification content="G-29MNLJYDQX"><link crossorigin=anonymous href=/assets/css/stylesheet.3299c596a7007118365635c056dd427dace22b7b8c1341fdef6fa6c31359ba10.css integrity="sha256-MpnFlqcAcRg2VjXAVt1CfaziK3uME0H972+mwxNZuhA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.jakobthe.dev/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.jakobthe.dev/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.jakobthe.dev/images/favicon-32x32.png><link rel=apple-touch-icon href=https://www.jakobthe.dev/images/apple-touch-icon.png><link rel=mask-icon href=https://www.jakobthe.dev/images/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-29MNLJYDQX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-29MNLJYDQX",{anonymize_ip:!1})}</script><meta property="og:title" content="Breaking into Encrypted iPhone Backups"><meta property="og:description" content="The day that being a hacker made me feel like a hero."><meta property="og:type" content="article"><meta property="og:url" content="https://www.jakobthe.dev/posts/breaking-into-iphone-backups/"><meta property="og:image" content="https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-21T15:45:00+10:30"><meta property="article:modified_time" content="2018-11-21T15:45:00+10:30"><meta property="og:site_name" content="JakobTheDev"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero.jpg"><meta name=twitter:title content="Breaking into Encrypted iPhone Backups"><meta name=twitter:description content="The day that being a hacker made me feel like a hero."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.jakobthe.dev/posts/"},{"@type":"ListItem","position":2,"name":"Breaking into Encrypted iPhone Backups","item":"https://www.jakobthe.dev/posts/breaking-into-iphone-backups/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Breaking into Encrypted iPhone Backups","name":"Breaking into Encrypted iPhone Backups","description":"The day that being a hacker made me feel like a hero.","keywords":["Cryptography","iPhone","Password Cracking"],"articleBody":"This is a story about my favourite moment in Information Security so far. I thought, rather than just breaking down the technical part, I’d branch out and try something different. If you’re just interested in iOS security, feel free to skip ahead 👌\nNote: Unfortunately, for legal reasons, I can’t crack your password for you.\nIf you’ve ever worked in the IT industry, are good with computers, or were simply born after 1980, then you’re probably asked every other week to provide tech support. It may come from your family, it may come from your friends, but inevitably you’ll get a message or a call from somebody in distress whose hard drive has died or Facebook was hacked.\nThis forces you to do some mental arithmetic on your ethics. You want to help people, but you’re a busy person and these things take time to do. Plus, you know you’ll be doing it for free, and are you really that close with this person? Inevitably, you say yes because of who you are as a person, then spend the next week of your free time cleaning viruses, replacing hard drives, reinstalling Windows and doing whatever else needs to be done.\nRecently, I got a message from a good friend of mine:\nDo you have a program that can unlock passwords that I can’t reset? 😥\nAfter some back and forth, I worked out that my friend (let’s call her Jesse) had bought a new iPhone and wanted to restore the backup from her old phone. The problem was that the backup was encrypted and, of course, she couldn’t remember the password. It was one of those cases where the thing that’s designed to keep the bad guys out was doing a pretty good job at keeping her out too. A safe doesn’t care that you own it; if you forget the combination then you’re out of luck.\nMy immediate response was “You want me to hack an iPhone? Hell no!”. I did the usual ethical arithmetic and figured that entering her contacts and downloading her apps manually was a small price to pay for forgetting a password. I told Jesse that Apple does a pretty good job at securing their stuff and that she would have to remember the password to restore the backup.\nOnce I told her the bad news, she got upset. The thing was, that backup contained the only copies of photos of her baby daughter. There was no cloud backup, no photos synchronised with iTunes, and no other camera or phone that had half as many photos as she had. She had tried every variation of the passwords she usually uses and contacting me was a last-ditch effort.\nNow, you’re going to have to believe me when I say this (because I won’t share a photo) but Jesse’s daughter happens to be the cutest little girl that has ever graced this planet. It’s not official or anything yet, but I’m sure there’s a committee somewhere that on seeing the lost pictures of Jesse’s baby daughter, they would immediately dub her “Cutest baby ever” and disband the committee forever.\nThis got me thinking. I really wanted to get into this backup, because in truth, the thought of those photos forever was pretty upsetting. I made it my mission to find a way to get those photos back.\nHere’s how I went about it.\n🚪Finding a Way In Motivation and coffee on my side, I started doing some reading. I found a few programs that claimed to be able to unlock encrypted iPhone backups. I knew that behind the scenes, these programs must be doing some form of password cracking, and I would be trading performance for convenience. Since I have a decent gaming rig and have worked with password crackers before, I figured I’d have better luck cracking the password directly.\nI did a little more reading an found this article which gave me hope. I had made the assumption that I would need the entire backup in order to crack the password, and on Austalia’s less-than-fantastic internet, it would take days for Jesse to upload the files.\nAs it turns out, all I needed was the Manifest.plist file that’s inside the backup’s folder. This file, amongst other things, contains the Backup Key Bag which is described in the iOS Security Guide:\nBackup keybag is created when an encrypted backup is made by iTunes and stored on the computer to which the device is backed up. A new keybag is created with a new set of keys, and the backed-up data is re-encrypted to these new keys. As explained previously, non-migratory Keychain items remain iOS Security wrapped with the UID-derived key, allowing them to be restored to the device they were originally backed up from, but rendering them inaccessible on a different device.\nThe keybag is protected with the password set in iTunes, run through 10 million iterations of PBKDF2. Despite this large iteration count, there’s no tie to a specific device, and therefore a brute-force attack parallelized across many computers could theoretically be attempted on the backup keybag. This threat can be mitigated with a sufficiently strong password.\nIf a user chooses not to encrypt an iTunes backup, the backup files aren’t encrypted regardless of their Data Protection class, but the Keychain remains protected with a UID-derived key. This is why Keychain items migrate to a new device only if a backup password is set.\nTL;DR, the Key Bag contains the keys that are used to encrypt and decrypt the backup files, and the Key Bag is encrypted with the backup password. Importantly, the Key Bag is encrypted with 10 million passes of a brute-force resistant hashing algorithm. This is really clever, by doing this Apple has made it significantly more difficult to crack the password without impacting the performance of the device while it encrypts and decrypted data stored on the phone.\nUnfortunately, this makes life harder for us.\nNote: I found it interesting that regardless of whether the user chooses to encypt the backup, Keychain items (credentials stored on the device) are encrypted regardless. The Keychain can only be restored onto a new device if the user has encrypted their backup and enters the password on the new device. +1 for iOS security.\nI also found a script that extracts the Key Bag from the Manifest.plist file in a format that can be cracked using Hashcat.\n🔒💣Let’s Get Cracking With a plan in mind, I started setting up the environment.\nI took a massive detour that didn’t impact the plan, but did cost me a few hours and really added to the stress and anticipation. Firstly, I had recently wiped my PC in preparation to sell it, so I had to get it set up and reinstall Windows. Next, I spent some time installing VMWare and setting up a Kali Linux VM which I would use for cracking. After some time downloading and setting up the environment, I found out that VMs can’t directly access the GPU in a typical configuration. Cue the trombone…\nAfter this digression, I found out that Hashcat is supported on Windows! You can download an executable from their website.\nThe next step was to extract the Key Bag. I downloaded the script from GitHub and ran it against theManifest.plist file, piping the output to a file.\nNote: You will need perl to run the script. Rather than installing the tools I regularly use on Linux in my Windows environment, I tend to use the Kali App based on the Windows Subsystem for Linux. It’s really handy for running terminal commands within your Windows filesystem which saves you from having to mess with shared folders on your Kali VM.\n./itunes\\_backup2hashcat.pl Manifest.plist | tee hashes.txt The script ran successfully and output a hash to the terminal and saved it to hashes.txt. The structure of the hash extracted from the Key Bag is dependent on the version of iOS. This is important, as it will determine how difficult the password will be to crack and which hash-mode we tell Hashcat to crack. Fortunately, this is easy to determine, as the hash begins with the following:\n$itunes\\_backup$\\*`IOS_VERSION`\\* With the iOS version at hand, we can determine which hash mode to use in Hashcat. In this case, her phone was running iOS 10, which means we use hash mode 14800.\niOS Version Hash Mode iOS Version \u003c 10 14700 iOS Version \u003e= 10 14800 With the hash extracted, it was time to fire up the password cracker. Since Jesse had already tried each of the passwords she usually uses, I figured a pure brute-force would be a good place to start. Different iterations of her password were all under 10 characters, which you can usually brute force in the order of hours or days for passwords I had experience in cracking (WPA wireless, MD5 and variants of SHA hashes).\nhashcat -a 3 -m 14800 -o cracked.txt --outfile-format=2 --increment ?a?a?a?a?a?a?a?a?a?a hash.txt Boy was I wrong… That bit in the iOS Security guide where they said they made the password brute-force resistant? They weren’t kidding. I would expect my GPU (Nvidia GTX 1080) to pump out around 500,000 (500 kH/s) WPA2 hashes per second. For this hash?\n1. Hash. Per. Minute…\nA pure brute-force was clearly not going to work — we’re talking heat death of the universe before I get those baby photos back. We needed a new approach.\n🐱‍💻 Thinking like a hacker While all of this was happening I was talking with Jesse, keeping her up to date with how things were going and reassuring her that we may get lucky and get the photos back. I asked her to share with me the passwords she usually uses if she was willing to share. She did, and it was about what you’d expect. Different combinations of the same things — names, birthdays, lucky numbers. You know the drill.\nI started thinking that this could work in our favour. She had tried all every combination of these pieces she could think of. Maybe she had missed one, maybe if we managed to try every possible combination then we would find the right one.\nEach of her passwords followed a similar structure — beginning, middle and end — I wanted to keep this structure but make every permutation of the known parts, plus every combination of uppercase and lowercase letters. I looked around for tools that could generate a list of passwords based on a list of known character combinations. I could have written a pretty basic script to do this, but at this stage, I was more concerned with getting the result fast than practising my scripting.\nI came across this tool Mentalist which fit the bill perfectly! I played with the tool until I was familiar with how it worked and ended up producing a list of 96 passwords, one per line, which fit the format of what I wanted exactly.\n🦑 Release the Kraken Round 2. This time around, I did a dictionary attack based on the password list. I adjust the hashcat command and set it going, expecting it to take an hour or two to run.\nhashcat -a 0 -m 14800 -o cracked.txt –outfile-format=2 hash.txt passwords.txt\nBy this stage, it was getting pretty late. It had been a long day at work followed by hours of messing around with the backup and passwords and going on an emotional rollercoaster with Jesse. I sent her a message telling her that I was running something overnight, that I was hopeful it would work.\nI started to pack things up ready for bed when I noticed Hashcat had stopped running. Now in my experience, it’ll stop for one of two reasons — the end of the password list has been reached, or the password was found. There was no chance it had made it through the list in just a few minutes. My heart starts to pound and I get excited, but I don’t want to get my hopes up yet.\nI look inside the password dump file, and there it is. In plain sight, one of the passwords on the list. A thousand thoughts rushed through my head, was that the right password? Did Hascat crash and just output the password it was processing at the time? Did I accidentally stop the cracker when I was packing up.\nNervously, I send Jesse a message.\nWords really can’t describe the feeling. We spend the next 10 minutes flipping out as she unlocks the backup and starts restoring her phone.\n🤯 Lessons Learned I took this as an opportunity to talk to Jesse about some security basics. Firstly, this is exactly why you shouldn’t reuse passwords. Even if you change the password slightly every time you use it, it’s way too easy for somebody to produce a list of every password you use to protect your digital self. Secondly, she needed a better way to store her passwords so she doesn’t have to rely on her memory when she needs them.\nFortunately, we can kill two birds with one password manager. I cannot recommend highly enough using something like LastPass or 1Password. Not only do you not have to remember most of your passwords, but you can set really secure ones and easily access them on your desktop or even using your fingerprint reader on your phone. This is one of those cases where it’s more secure and actually makes things easier. Do it, you won’t regret it.\nSecondly, this was a lesson for me. Yeah, being asked to help people with their computer issues can be a drag sometimes. But hey, what’s the point of being good at something if you’re not willing to help your mates? It may not always end in euphoria or feeling like hackerman, but it’s a good thing to do. Take the opportunity.\n😎 Thanks Thanks to Darell Tan who wrote the article that inspired this one, Phillip for creating the Perl script used to extract the Key Bag, and Henry Prince for creating Mentalist. Also to the team at Hashcat for making a great tool 🔥\nThanks for reading!\nIf you enjoyed this post, follow on Twitter or Mastodon for more content. If you have any feedback or suggestions, leave it in the comments below and I’ll do my best to get back to you.\n","wordCount":"2398","inLanguage":"en","image":"https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero.jpg","datePublished":"2018-11-21T15:45:00+10:30","dateModified":"2018-11-21T15:45:00+10:30","author":{"@type":"Person","name":"Jakob Pennington"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.jakobthe.dev/posts/breaking-into-iphone-backups/"},"publisher":{"@type":"Organization","name":"JakobTheDev | Jakob Pennington","logo":{"@type":"ImageObject","url":"https://www.jakobthe.dev/images/favicon.ico"}}}</script><a rel=me style=display:none href=https://infosec.exchange/@JakobTheDev>Mastodon</a></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.jakobthe.dev/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.jakobthe.dev/about title=About><span>About</span></a></li><li><a href=https://www.jakobthe.dev/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://www.jakobthe.dev/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://www.jakobthe.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.jakobthe.dev/>Home</a>&nbsp;»&nbsp;<a href=https://www.jakobthe.dev/posts/>Posts</a></div><h1 class=post-title>Breaking into Encrypted iPhone Backups</h1><div class=post-description>The day that being a hacker made me feel like a hero.</div><div class=post-meta><span title='2018-11-21 15:45:00 +1030 ACDT'>21 November 2018</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2398 words&nbsp;·&nbsp;Jakob Pennington&nbsp;|&nbsp;<a href=https://github.com/JakobTheDev/website/content/posts/5-breaking-into-iphone-backups/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><a href=https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero.jpg target=_blank rel="noopener noreferrer"><img loading=lazy srcset="https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero_hu8e74b9ca6ee5c699878a4904f22d250f_1211290_360x0_resize_q75_box.jpg 360w ,https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero_hu8e74b9ca6ee5c699878a4904f22d250f_1211290_480x0_resize_q75_box.jpg 480w ,https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero_hu8e74b9ca6ee5c699878a4904f22d250f_1211290_720x0_resize_q75_box.jpg 720w ,https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero_hu8e74b9ca6ee5c699878a4904f22d250f_1211290_1080x0_resize_q75_box.jpg 1080w ,https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero_hu8e74b9ca6ee5c699878a4904f22d250f_1211290_1500x0_resize_q75_box.jpg 1500w ,https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero.jpg 3872w" sizes="(min-width: 768px) 720px, 100vw" src=https://www.jakobthe.dev/posts/breaking-into-iphone-backups/hero.jpg alt="A Superman Lego figurine on a tree stump." width=3872 height=2581></a></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#finding-a-wayin>🚪Finding a Way In</a></li><li><a href=#lets-getcracking>🔒💣Let’s Get Cracking</a></li><li><a href=#-thinking-like-ahacker>🐱‍💻 Thinking like a hacker</a></li><li><a href=#-release-thekraken>🦑 Release the Kraken</a></li><li><a href=#-lessonslearned>🤯 Lessons Learned</a></li><li><a href=#-thanks>😎 Thanks</a></li></ul></nav></div></details></div><div class=post-content><p>This is a story about my favourite moment in Information Security so far. I thought, rather than just breaking down the technical part, I’d branch out and try something different. If you’re just interested in iOS security, feel free to skip ahead 👌</p><blockquote><p><strong>Note:</strong> Unfortunately, for legal reasons, I can’t crack your password for you.</p></blockquote><hr><p>If you’ve ever worked in the IT industry, are good with computers, or were simply born after 1980, then you’re probably asked every other week to provide tech support. It may come from your family, it may come from your friends, but inevitably you’ll get a message or a call from somebody in distress whose hard drive has died or Facebook was hacked.</p><p>This forces you to do some mental arithmetic on your ethics. You want to help people, but you’re a busy person and these things take time to do. Plus, you know you’ll be doing it for free, and are you really that close with this person? Inevitably, you say yes because of who you are as a person, then spend the next week of your free time cleaning viruses, replacing hard drives, reinstalling Windows and doing whatever else needs to be done.</p><p>Recently, I got a message from a good friend of mine:</p><blockquote><p>Do you have a program that can unlock passwords that I can’t reset? 😥</p></blockquote><p>After some back and forth, I worked out that my friend (let’s call her Jesse) had bought a new iPhone and wanted to restore the backup from her old phone. The problem was that the backup was encrypted and, of course, she couldn’t remember the password. It was one of those cases where the thing that’s designed to keep the bad guys out was doing a pretty good job at keeping her out too. A safe doesn’t care that you own it; if you forget the combination then you’re out of luck.</p><p>My immediate response was “You want me to hack an iPhone? Hell no!”. I did the usual ethical arithmetic and figured that entering her contacts and downloading her apps manually was a small price to pay for forgetting a password. I told Jesse that Apple does a pretty good job at securing their stuff and that she would have to remember the password to restore the backup.</p><p>Once I told her the bad news, she got upset. The thing was, that backup contained the only copies of photos of her baby daughter. There was no cloud backup, no photos synchronised with iTunes, and no other camera or phone that had half as many photos as she had. She had tried every variation of the passwords she usually uses and contacting me was a last-ditch effort.</p><p>Now, you’re going to have to believe me when I say this (because I won’t share a photo) but Jesse’s daughter happens to be the cutest little girl that has ever graced this planet. It’s not official or anything yet, but I’m sure there’s a committee somewhere that on seeing the lost pictures of Jesse’s baby daughter, they would immediately dub her “Cutest baby ever” and disband the committee forever.</p><p>This got me thinking. I really wanted to get into this backup, because in truth, the thought of those photos forever was pretty upsetting. I made it my mission to find a way to get those photos back.</p><p>Here’s how I went about it.</p><h2 id=finding-a-wayin>🚪Finding a Way In<a hidden class=anchor aria-hidden=true href=#finding-a-wayin>#</a></h2><p>Motivation and coffee on my side, I started doing some reading. I found a few <a href=https://www.imobie.com/phonerescue/ios-data-recovery.htm>programs</a> that claimed to be able to unlock encrypted iPhone backups. I knew that behind the scenes, these programs must be doing some form of password cracking, and I would be trading performance for convenience. Since I have a decent gaming rig and have worked with password crackers before, I figured I’d have better luck cracking the password directly.</p><p>I did a little more reading an found <a href=http://irq5.io/2017/03/07/cracking-itunes-backup-passwords-with-hashcat/>this article</a> which gave me hope. I had made the assumption that I would need the entire backup in order to crack the password, and on Austalia’s less-than-fantastic internet, it would take days for Jesse to upload the files.</p><p>As it turns out, all I needed was the <code>Manifest.plist</code> file that’s inside the backup’s folder. This file, amongst other things, contains the <strong>Backup Key Bag</strong> which is described in the <a href=https://www.apple.com/business/site/docs/iOS_Security_Guide.pdf>iOS Security Guide</a>:</p><blockquote><p>Backup keybag is created when an encrypted backup is made by iTunes and stored on the computer to which the device is backed up. A new keybag is created with a new set of keys, and the backed-up data is re-encrypted to these new keys. As explained previously, non-migratory Keychain items remain iOS Security wrapped with the UID-derived key, allowing them to be restored to the device they were originally backed up from, but rendering them inaccessible on a different device.</p></blockquote><blockquote><p>The keybag is protected with the password set in iTunes, run through 10 million iterations of PBKDF2. Despite this large iteration count, there’s no tie to a specific device, and therefore a brute-force attack parallelized across many computers could theoretically be attempted on the backup keybag. This threat can be mitigated with a sufficiently strong password.</p></blockquote><blockquote><p>If a user chooses not to encrypt an iTunes backup, the backup files aren’t encrypted regardless of their Data Protection class, but the Keychain remains protected with a UID-derived key. This is why Keychain items migrate to a new device only if a backup password is set.</p></blockquote><p><strong>TL;DR</strong>, the Key Bag contains the keys that are used to encrypt and decrypt the backup files, and the Key Bag is encrypted with the backup password. Importantly, the Key Bag is encrypted with 10 million passes of a brute-force resistant hashing algorithm. This is really clever, by doing this Apple has made it significantly more difficult to crack the password without impacting the performance of the device while it encrypts and decrypted data stored on the phone.</p><p>Unfortunately, this makes life harder for us.</p><blockquote><p><strong>Note:</strong> I found it interesting that regardless of whether the user chooses to encypt the backup, Keychain items (credentials stored on the device) are encrypted regardless. The Keychain can only be restored onto a new device if the user has encrypted their backup and enters the password on the new device. +1 for iOS security.</p></blockquote><p>I also found a <a href=https://github.com/philsmd/itunes_backup2hashcat>script</a> that extracts the Key Bag from the <code>Manifest.plist</code> file in a format that can be cracked using <a href=https://hashcat.net/hashcat/>Hashcat</a>.</p><h2 id=lets-getcracking>🔒💣Let’s Get Cracking<a hidden class=anchor aria-hidden=true href=#lets-getcracking>#</a></h2><p>With a plan in mind, I started setting up the environment.</p><p>I took a massive detour that didn’t impact the plan, but did cost me a few hours and really added to the stress and anticipation. Firstly, I had recently wiped my PC in preparation to sell it, so I had to get it set up and reinstall Windows. Next, I spent some time installing VMWare and setting up a Kali Linux VM which I would use for cracking. After some time downloading and setting up the environment, I found out that VMs can’t directly access the GPU in a typical configuration. Cue the trombone…</p><p>After this digression, I found out that Hashcat is supported on Windows! You can download an executable from their <a href=https://hashcat.net/hashcat/>website</a>.</p><p>The next step was to extract the Key Bag. I downloaded the script from GitHub and ran it against the<code>Manifest.plist</code> file, piping the output to a file.</p><blockquote><p><strong>Note:</strong> You will need perl to run the script. Rather than installing the tools I regularly use on Linux in my Windows environment, I tend to use the <a href=https://www.kali.org/news/kali-linux-in-the-windows-app-store/>Kali App</a> based on the Windows Subsystem for Linux. It’s really handy for running terminal commands within your Windows filesystem which saves you from having to mess with shared folders on your Kali VM.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./itunes<span class=se>\_</span>backup2hashcat.pl Manifest.plist <span class=p>|</span> tee hashes.txt
</span></span></code></pre></div><p>The script ran successfully and output a hash to the terminal and saved it to <code>hashes.txt</code>. The structure of the hash extracted from the Key Bag is dependent on the version of iOS. This is important, as it will determine how difficult the password will be to crack and which hash-mode we tell Hashcat to crack. Fortunately, this is easy to determine, as the hash begins with the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$itunes</span><span class=se>\_</span>backup$<span class=se>\*</span><span class=sb>`</span>IOS_VERSION<span class=sb>`</span><span class=se>\*</span>
</span></span></code></pre></div><p>With the iOS version at hand, we can determine which hash mode to use in Hashcat. In this case, her phone was running iOS 10, which means we use hash mode 14800.</p><table><thead><tr><th>iOS Version</th><th>Hash Mode</th></tr></thead><tbody><tr><td>iOS Version &lt; 10</td><td>14700</td></tr><tr><td>iOS Version >= 10</td><td>14800</td></tr></tbody></table><p>With the hash extracted, it was time to fire up the password cracker. Since Jesse had already tried each of the passwords she usually uses, I figured a pure brute-force would be a good place to start. Different iterations of her password were all under 10 characters, which you can usually brute force in the order of hours or days for passwords I had experience in cracking (WPA wireless, MD5 and variants of SHA hashes).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hashcat -a <span class=m>3</span> -m <span class=m>14800</span> -o cracked.txt --outfile-format<span class=o>=</span><span class=m>2</span> --increment ?a?a?a?a?a?a?a?a?a?a hash.txt
</span></span></code></pre></div><p>Boy was I wrong… That bit in the iOS Security guide where they said they made the password brute-force resistant? They weren’t kidding. I would expect my GPU (Nvidia GTX 1080) to pump out around 500,000 (500 kH/s) WPA2 hashes per second. For this hash?</p><blockquote><p>1. Hash. Per. Minute…</p></blockquote><p>A pure brute-force was clearly not going to work — we’re talking heat death of the universe before I get those baby photos back. We needed a new approach.</p><h2 id=-thinking-like-ahacker>🐱‍💻 Thinking like a hacker<a hidden class=anchor aria-hidden=true href=#-thinking-like-ahacker>#</a></h2><p>While all of this was happening I was talking with Jesse, keeping her up to date with how things were going and reassuring her that we may get lucky and get the photos back. I asked her to share with me the passwords she usually uses if she was willing to share. She did, and it was about what you’d expect. Different combinations of the same things — names, birthdays, lucky numbers. You know the drill.</p><p>I started thinking that this could work in our favour. She had tried all every combination of these pieces she could think of. Maybe she had missed one, maybe if we managed to try every possible combination then we would find the right one.</p><p>Each of her passwords followed a similar structure — beginning, middle and end — I wanted to keep this structure but make every permutation of the known parts, plus every combination of uppercase and lowercase letters. I looked around for tools that could generate a list of passwords based on a list of known character combinations. I could have written a pretty basic script to do this, but at this stage, I was more concerned with getting the result fast than practising my scripting.</p><p>I came across this tool <a href=https://github.com/sc0tfree/mentalist>Mentalist</a> which fit the bill perfectly! I played with the tool until I was familiar with how it worked and ended up producing a list of 96 passwords, one per line, which fit the format of what I wanted exactly.</p><h2 id=-release-thekraken>🦑 Release the Kraken<a hidden class=anchor aria-hidden=true href=#-release-thekraken>#</a></h2><p>Round 2. This time around, I did a dictionary attack based on the password list. I adjust the hashcat command and set it going, expecting it to take an hour or two to run.</p><p>hashcat -a 0 -m 14800 -o cracked.txt &ndash;outfile-format=2 hash.txt passwords.txt</p><p>By this stage, it was getting pretty late. It had been a long day at work followed by hours of messing around with the backup and passwords and going on an emotional rollercoaster with Jesse. I sent her a message telling her that I was running something overnight, that I was hopeful it would work.</p><p><img loading=lazy src=messenger-jessie-starting.png alt="A message thread with Jessie, letting her know that I was running something overnight to try to get her password."></p><p>I started to pack things up ready for bed when I noticed Hashcat had stopped running. Now in my experience, it’ll stop for one of two reasons — the end of the password list has been reached, or the password was found. There was no chance it had made it through the list in just a few minutes. My heart starts to pound and I get excited, but I don’t want to get my hopes up yet.</p><p>I look inside the password dump file, and there it is. In plain sight, one of the passwords on the list. A thousand thoughts rushed through my head, was that the right password? Did Hascat crash and just output the password it was processing at the time? Did I accidentally stop the cracker when I was packing up.</p><p>Nervously, I send Jesse a message.</p><p><img loading=lazy src=messenger-jessie-success.jpeg alt="A message thread with Jessie, giving her the password. We are both very excited."></p><p>Words really can’t describe the feeling. We spend the next 10 minutes flipping out as she unlocks the backup and starts restoring her phone.</p><h2 id=-lessonslearned>🤯 Lessons Learned<a hidden class=anchor aria-hidden=true href=#-lessonslearned>#</a></h2><p>I took this as an opportunity to talk to Jesse about some security basics. Firstly, this is exactly why you shouldn’t reuse passwords. Even if you change the password slightly every time you use it, it’s way too easy for somebody to produce a list of every password you use to protect your digital self. Secondly, she needed a better way to store her passwords so she doesn’t have to rely on her memory when she needs them.</p><p>Fortunately, we can kill two birds with one password manager. I cannot recommend highly enough using something like <a href=https://www.lastpass.com/>LastPass</a> or <a href=https://1password.com/>1Password</a>. Not only do you not have to remember most of your passwords, but you can set really secure ones and easily access them on your desktop or even using your fingerprint reader on your phone. This is one of those cases where it’s more secure and actually makes things easier. Do it, you won’t regret it.</p><p>Secondly, this was a lesson for me. Yeah, being asked to help people with their computer issues can be a drag sometimes. But hey, what’s the point of being good at something if you’re not willing to help your mates? It may not always end in euphoria or feeling like hackerman, but it’s a good thing to do. Take the opportunity.</p><h2 id=-thanks>😎 Thanks<a hidden class=anchor aria-hidden=true href=#-thanks>#</a></h2><p>Thanks to <a href=https://github.com/geekman>Darell Tan</a> who wrote the article that inspired this one, <a href=https://github.com/philsmd>Phillip</a> for creating the Perl script used to extract the Key Bag, and <a href=https://github.com/sc0tfree/mentalist>Henry Prince</a> for creating Mentalist. Also to the team at <a href=https://twitter.com/hashcat>Hashcat</a> for making a great tool 🔥</p><hr><p><strong>Thanks for reading!</strong><br>If you enjoyed this post, follow on <a href=https://www.twitter.com/@JakobTheDev>Twitter</a> or <a href=https://infosec.exchange/@JakobTheDev>Mastodon</a> for more content. If you have any feedback or suggestions, leave it in the comments below and I&rsquo;ll do my best to get back to you.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.jakobthe.dev/tags/cryptography/>Cryptography</a></li><li><a href=https://www.jakobthe.dev/tags/iphone/>iPhone</a></li><li><a href=https://www.jakobthe.dev/tags/password-cracking/>Password Cracking</a></li></ul><nav class=paginav><a class=prev href=https://www.jakobthe.dev/posts/exploiting-xss-via-markdown/><span class=title>« Prev</span><br><span>Exploiting XSS via Markdown</span></a>
<a class=next href=https://www.jakobthe.dev/posts/codepipeline-notifications/><span class=title>Next »</span><br><span>Add Notifications to your AWS CI/CD Pipeline</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Breaking into Encrypted iPhone Backups on twitter" href="https://twitter.com/intent/tweet/?text=Breaking%20into%20Encrypted%20iPhone%20Backups&url=https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f&hashtags=Cryptography%2ciPhone%2cPasswordCracking"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Breaking into Encrypted iPhone Backups on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f&title=Breaking%20into%20Encrypted%20iPhone%20Backups&summary=Breaking%20into%20Encrypted%20iPhone%20Backups&source=https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Breaking into Encrypted iPhone Backups on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f&title=Breaking%20into%20Encrypted%20iPhone%20Backups"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Breaking into Encrypted iPhone Backups on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Breaking into Encrypted iPhone Backups on whatsapp" href="https://api.whatsapp.com/send?text=Breaking%20into%20Encrypted%20iPhone%20Backups%20-%20https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Breaking into Encrypted iPhone Backups on telegram" href="https://telegram.me/share/url?text=Breaking%20into%20Encrypted%20iPhone%20Backups&url=https%3a%2f%2fwww.jakobthe.dev%2fposts%2fbreaking-into-iphone-backups%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//JakobTheDev.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.jakobthe.dev/>JakobTheDev | Jakob Pennington</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>